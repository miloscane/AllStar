<!DOCTYPE html>
<html lang="rs">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>AllStar</title>

		<!-- Bootstrap -->
		<link href="/stylePotera.css?<%= new Date().getTime();%>" rel="stylesheet">
		<link rel="icon" type="image/x-icon" href="https://allstar.rs/favicon.png">
        <link rel="apple-touch-icon" href="https://allstar.rs/favicon.png">
        <meta property="og:title" content="All Star Pikado" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://pikado.allstar.rs" />
        <meta property="og:image" content="https://allstar.rs/images/ogImage.png" />
        <meta property="og:description" content="064/336-3-738" />
		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body style="min-height:100vh;" class="poruci">
		<div style="width:75px;margin:0 auto;padding-top:10px;">
			<img src="<%=bucket%>/images/allstar.png">
		</div>
		<div class="title">Pamet u čaši</div>
		<div class="mainInlines">
			<div class="logo">
				<img src="<%=bucket%>/images/szs.svg">
			</div>
			<div class="timer">
				<div class="timeWrap">
					<button onclick="timer(1)" style="font-size:14px;color:rgb(0,0,0)">Start tajmer</button>
					<button onclick="timer(0)" style="font-size:14px;color:rgb(0,0,0)">Pauziraj tajmer</button>
					<button onclick="timer(-1)" style="font-size:14px;color:rgb(0,0,0)">Resetuj tajmer</button>
					<button onclick="resetujSkor()" style="font-size:14px;color:rgb(0,0,0)">Resetuj skor</button>
				</div>
				<div class="scores">
					<div class="score">
						<div id="score1" class="scorePrint">19</div>
					</div>
					<div class="score">
						<div id="score2" class="scorePrint">18</div>
					</div>
				</div>
			</div>
			<div class="logo">
				<img src="<%=bucket%>/images/allstar.png">
			</div>
		</div>
		<div class="scoreBars" style="position:relative">
			<div class="row" id="bars1"></div>
			<div class="row" id="bars2"></div>
			<button onclick="plusminus(-1,1)" style="font-size:20px;font-weight:bold;color:black;padding:5px;position:absolute;top:5px;left:5px;">-</button>
			<button onclick="plusminus(1,1)" style="font-size:20px;font-weight:bold;color:black;padding:5px;position:absolute;top:5px;right:5px;">+</button>
			<button onclick="plusminus(-1,2)" style="font-size:20px;font-weight:bold;color:black;padding:5px;position:absolute;top:85px;left:5px;">-</button>
			<button onclick="plusminus(1,2)" style="font-size:20px;font-weight:bold;color:black;padding:5px;position:absolute;top:85px;right:5px;">+</button>
			<div class="plusminus"></div>
		</div>
		<script>
			var potera = <%-JSON.stringify(potera)%>;
			var serverKey = "<%=serverKey%>";
			var rows = document.getElementsByClassName("scoreBars")[0].getElementsByClassName("row");
			for(var i=0;i<rows.length;i++){
				for(var j=0;j<30;j++){
					var bar = document.createElement("DIV");
					bar.setAttribute("class","bar");
					bar.setAttribute("onclick","updateFromBar(this)")
					 var fill = document.createElement("DIV");
					 fill.setAttribute("class","fill")
					 bar.appendChild(fill);
					rows[i].appendChild(bar);
				}
			}

			function updateFromPotera(){
				for(var i=0;i<rows.length;i++){
					var bars = rows[i].getElementsByClassName("bar");
					for(var j=0;j<bars.length;j++){
						bars[j].classList.remove("fillActive")
					}
					var score;
					if(i==0){
						score = potera.tim1;
						document.getElementById("score1").textContent = score
					}else if(i==1){
						score = potera.tim2;
						document.getElementById("score2").textContent = score
					}
					for(var j=0;j<score;j++){
						bars[j].classList.add("fillActive")
					}
				}
			}

			updateFromPotera();

			function updateFromBar(elem){
				var elemIndex = -1;
				var bars = elem.parentElement.getElementsByClassName("bar");
				for(var i=0;i<bars.length;i++){
					if(bars[i]==elem){
						elemIndex = i+1;
					}
				}
				if(elemIndex>=0){
					if(elem.parentElement.id=="bars1"){
						potera.tim1=elemIndex;
						updateFromPotera();
						console.log(potera)
						sendPotera();
					}else if(elem.parentElement.id=="bars2"){
						potera.tim2=elemIndex;
						updateFromPotera();
						console.log(potera)
						sendPotera();
					}else{
						console.log("Couldn't figure out which bar to update")
					}
				}else{
					console.log("Couldn't figure out element index");
				}
				
			}

			function plusminus(direction,row){
				if(row==1){
					potera.tim1 = Number(potera.tim1)+direction
				}else if(row==2){
					potera.tim2 = Number(potera.tim2)+direction
				}
				updateFromPotera()
				sendPotera();
			}

			function resetujSkor(){
				potera.tim1=0;
				potera.tim2=0;
				updateFromPotera()
				sendPotera();
			}

			async function sendPotera() {
			  try {
			    const res = await fetch('/potera', {
			      method: 'POST',
			      headers: { 'Content-Type': 'application/json' },
			      body: JSON.stringify({ key: serverKey, json: potera })
			    });

			    const text = await res.text();
			    if (!res.ok || text !== "Ok") {
			      console.error("Potera update failed:", res.status, text);
			    }
			  } catch (e) {
			    console.error(e);
			  }
			}

			function timer(value){
				potera.timer = value;
				sendPotera();
			}
		</script>
		
	</body>
</html>